# Web API setup/configuration
Before the web API can be used, it must first be set up. The web API cannot be used without API authentication. 
This means one of the steps is API key generation.

The web API and interface are both Django applications. Cuckoo has built-in settings for these. These can be overwritten
by modifying the following files:

- `$CWD/web/api_local_settings.py` (For the web API)
- `$CWD/web/web_local_settings.py` (For the web interface)

The web API has its own subcommand:

    cuckoo api

The following is its help page:

```
Usage: cuckoo api [OPTIONS] COMMAND [ARGS]...

  Start the Cuckoo web API (development server)

Options:
  -h, --host TEXT     Host to bind the development web API server on
  -p, --port INTEGER  Port to bind the development web API server on
  --autoreload        Automatically reload modified Python files
  --help              Show this message and exit.

Commands:
  djangocommand   Arguments for this command are passed to Django.
  generateconfig  Generate basic configurations for uWSGI and NGINX
  token           List, create, and delete API tokens.
```


To start using the API, perform the following steps:

#### Applying migrations

**1. Try starting the web API using the following command.**

        cuckoo api

If you have never started and performed these steps before, the following message should appear:

```
Django database migrations required. Run 'cuckoo --cwd /home/cuckoo/.cuckoocwd api djangocommand migrate' to perform the migration.
```

The API uses a database to store the created users/api keys. No correct database exists yet. By default the used database will be SQLite and stored in `$CWD/web/api.db`.

**2. Apply the required migrations.**

Run the command suggested in the previous step:

    cuckoo api djangocommand migrate

This should result in one or more migrations being applied. If this is succesful, continue to the next step.

#### API key creation

**Create one or more API keys.**

The API keys can be managed by a cuckoo api subcommand: `cuckoo api token`. Its help output is the following:

```
Usage: cuckoo api token [OPTIONS]

  List, create, and delete API tokens.

Options:
  -l, --list            List all current API tokens and their owners
  -c, --create TEXT     Create a new API token for a given owner name
  --admin               Grant admin priviles to API token being created
  -d, --delete INTEGER  Delete the specified token by its token ID
  --clear               Delete all API tokens
  --help                Show this message and exit.
```

Create an API using the following command:

    cuckoo api token --create <owner name>

Output similar to this will appear:

`Created key cb60aa0d689d7f0281a5ae4d661544927273b087 with ID: 1`

This is the key that should be sent in an Authentication header when using the API.
The header format must be: `Authentication: token <api key>`.

Example: 

```bash
curl "http://127.0.0.1:8090/analyses" -H "Authentication: token cb60aa0d689d7f0281a5ae4d661544927273b087"
```

All API keys can be listed using: `cuckoo api token --list`

Output example:

```
|   Key ID | Owner   | Is admin   | Created on       | API Key                                  |
|----------|---------|------------|------------------|------------------------------------------|
|        1 | example | False      | 2021-07-06 15:56 | cb60aa0d689d7f0281a5ae4d661544927273b087 |
```


#### Starting the API

The API can be started using the `cuckoo api` command. The following starts the Django development web server. 

`cuckoo api --host <listen ip> --port <listen port>`

#### Serving the API with uWSGI and NGINX

The `cuckoo api` command will start the Django development server. To actually serve the API in production, it is advisable to use a
combination of uWSGI (to run the API) and NGINX (to serve the running API). Cuckoo can generate a basic configuration for both of these.

The `uwsgi-plugin-python3` system package or the `uwsgi` Python package must be installed in the virtualenv for this to work.

The generated configs will contain the paths of your Cuckoo install and virtualenv. Do not copy this following example configurations, generate them instead.

**Generating a uWSGI config**

    cuckoo api generateconfig --uwsgi

Example output:

```ini
; This is a basic uWSGI configuration generated by Cuckoo. It is
; recommended to review it and change it where needed. This configuration
; is meant to be used together with the generated NGINX configuration.
[uwsgi]
; To run this, the uwsgi-plugin-python3 system package must be installed or
; it must be run from a Python3 installation that has uwsgi installed.
plugins = python3,logfile
chdir = /home/cuckoo/cuckoo3/web/cuckoo/web
wsgi-file = api/wsgi.py
; The socket for NGINX to talk to. This should not listen on other
; addresses than localhost.
socket = 127.0.0.1:9080

; Verify that the users below are not root users and can read/write to/from 
; the Cuckoo CWD and installation. The configuration generator simply enters
; the user generating the configuration.
uid = cuckoo
gid = cuckoo

need-app = true
master = true
env = CUCKOO_APP=api
env = CUCKOO_CWD=/home/cuckoo/.cuckoocwd
env = CUCKOO_LOGLEVEL=debug

; Log uWSGI app and Cuckoo web logs to the following file. Change this to
; any path, but be sure the uid/gid user has write permissions to this path. 
logger = file:logfile=/tmp/cuckooapi-uwsgi.log

; The path of the Python 3 virtualenv Cuckoo is installed in.
virtualenv = /home/cuckoo/cuckoo3venv
```

**Generating a NGINX config**

    cuckoo api generateconfig --nginx

Example output:

```
# This is a basic NGINX configuration generated by Cuckoo. It is
# recommended to review it and change it where needed. This configuration
# is meant to be used together with the generated uWSGI configuration.
upstream _uwsgi_cuckoo_api {
    server 127.0.0.1:9080;
}

server {
    listen 127.0.0.1:8090;

    # It is not recommended to cache paths, this can cause results to be
    # outdated/wrong.
    location / {
        client_max_body_size 1G;
        proxy_redirect off;
        proxy_set_header X-Forwarded-Proto $scheme;
        include uwsgi_params;
        uwsgi_pass _uwsgi_cuckoo_api;
    }
}

```